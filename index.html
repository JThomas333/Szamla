<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <title>Számlakezelő</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 1em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin-bottom: 1em;
    }
    th, td {
      padding: 0.5em;
      border: 1px solid #ccc;
    }
    th {
      background: #eee;
    }
    button {
      padding: 0.5em;
      margin: 0.2em;
    }
    input {
      width: 95%;
    }
    .flex-container {
      display: flex;
      gap: 2em;
    }
    .half {
      flex: 1;
    }
  </style>
</head>
<body>
  <h1>Számlák</h1>
  <button onclick="toggleSzamlak()">Számlák listázása</button>
  <table border="1" id="szamlaTable" style="display: none;">
    <tr>
      <th>Szám</th><th>Kiállító</th><th>Vevő</th><th>Kelte</th><th>Teljesítés</th><th>Határidő</th><th>Végösszeg</th><th>ÁFA</th><th>Stornózott?</th><th>Művelet</th>
    </tr>
  </table>

  <h1>Partnerek</h1>
  <button onclick="togglePartnerek()">Eladók és vevők megjelenítése</button>
  <div class="flex-container" id="partnerSection" style="display: none;">
    <div class="half">
      <h2>Eladók</h2>
      <table id="eladoTable">
        <tr>
          <th>Név</th><th>Cím</th><th>Adószám</th><th>Művelet</th>
        </tr>
      </table>
    </div>
    <div class="half">
      <h2>Vevők</h2>
      <table id="vevoTable">
        <tr>
          <th>Név</th><th>Cím</th><th>Adószám</th><th>Művelet</th>
        </tr>
      </table>
    </div>
  </div>

  <script>
    let isSzamlaVisible = false;
    let isPartnerVisible = false;

    async function toggleSzamlak() {
      const table = document.getElementById("szamlaTable");
      if (isSzamlaVisible) {
        table.style.display = "none";
        isSzamlaVisible = false;
        return;
      }
      await loadSzamlak();
      table.style.display = "table";
      isSzamlaVisible = true;
    }

    async function loadSzamlak() {
      const res = await fetch("http://localhost:8080/szamlak");
      const szamlak = await res.json();
      const table = document.getElementById("szamlaTable");
      while (table.rows.length > 1) table.deleteRow(1);
      for (const sz of szamlak) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${sz.szamlaszam}</td>
          <td>${sz.kiallito_nev}</td>
          <td>${sz.vevo_nev}</td>
          <td>${sz.kelte}</td>
          <td>${sz.teljesites}</td>
          <td>${sz.hatarido}</td>
          <td>${sz.vegosszeg}</td>
          <td>${sz.afa}</td>
          <td>${sz.is_storno ? "Igen" : "Nem"}</td>
          <td>${sz.is_storno ? "" : `<button onclick="stornoSzamla(${sz.id})">Stornó</button>`}</td>
        `;
        table.appendChild(row);
      }
    }

    async function stornoSzamla(id) {
      if (!confirm("Biztosan stornózni szeretnéd a számlát?")) return;
      const res = await fetch(`http://localhost:8080/szamlak/${id}/storno`, {
        method: "POST"
      });
      if (res.ok) {
        alert("Számla sikeresen stornózva.");
        loadSzamlak();
      } else {
        alert("Hiba történt a stornózás során.");
      }
    }

    async function togglePartnerek() {
      const section = document.getElementById("partnerSection");
      if (isPartnerVisible) {
        section.style.display = "none";
        isPartnerVisible = false;
        return;
      }
      await loadPartnerek();
      section.style.display = "flex";
      isPartnerVisible = true;
    }

    async function loadPartnerek() {
      // Eladók és vevők külön lekérése
      const eladokRes = await fetch("http://localhost:8080/eladok");
      const vevokRes = await fetch("http://localhost:8080/vevok");
      const eladok = await eladokRes.json();
      const vevok = await vevokRes.json();

      const eladoTable = document.getElementById("eladoTable");
      const vevoTable = document.getElementById("vevoTable");

      // Töröljük a korábbi sorokat (kivéve a fejlécet)
      while (eladoTable.rows.length > 1) eladoTable.deleteRow(1);
      while (vevoTable.rows.length > 1) vevoTable.deleteRow(1);

      eladok.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="text" value="${p.nev}" id="eladoNev${p.id}" /></td>
          <td><input type="text" value="${p.cim}" id="eladoCim${p.id}" /></td>
          <td><input type="text" value="${p.adoszam}" id="eladoAdoszam${p.id}" /></td>
          <td><button onclick="updatePartner(${p.id}, 'elado')">Mentés</button></td>
        `;
        eladoTable.appendChild(row);
      });

      vevok.forEach(p => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td><input type="text" value="${p.nev}" id="vevoNev${p.id}" /></td>
          <td><input type="text" value="${p.cim}" id="vevoCim${p.id}" /></td>
          <td><input type="text" value="${p.adoszam}" id="vevoAdoszam${p.id}" /></td>
          <td><button onclick="updatePartner(${p.id}, 'vevo')">Mentés</button></td>
        `;
        vevoTable.appendChild(row);
      });
    }

    async function updatePartner(id, tipus) {
      let nev, cim, adoszam;
      if (tipus === "elado") {
        nev = document.getElementById(`eladoNev${id}`).value.trim();
        cim = document.getElementById(`eladoCim${id}`).value.trim();
        adoszam = document.getElementById(`eladoAdoszam${id}`).value.trim();
      } else {
        nev = document.getElementById(`vevoNev${id}`).value.trim();
        cim = document.getElementById(`vevoCim${id}`).value.trim();
        adoszam = document.getElementById(`vevoAdoszam${id}`).value.trim();
      }

      if (!nev || !cim || !adoszam) {
        alert("Kérlek tölts ki minden mezőt!");
        return;
      }

      const res = await fetch(`http://localhost:8080/partnerek/${id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ nev, cim, adoszam })
      });

      if (res.ok) {
        alert("Partner adatai frissítve.");
        if (isSzamlaVisible) loadSzamlak(); // Frissítjük a számlákat is, hogy látszódjon az új név
      } else {
        alert("Hiba történt a frissítés során.");
      }
    }
  </script>
</body>
</html>
